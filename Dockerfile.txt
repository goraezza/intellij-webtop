FROM debian:bullseye

ENV DEBIAN_FRONTEND=noninteractive

# Instalar dependencias
RUN apt-get update && apt-get install -y \
    xfce4 xfce4-goodies \
    tightvncserver \
    wget \
    jq \
    libgtk-3-0 libxext6 libxrender1 libxtst6 libxi6 libfreetype6 libx11-xcb1 \
    ca-certificates \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Crear usuario sin privilegios
RUN useradd -ms /bin/bash developer
USER developer
WORKDIR /home/developer

# Configurar VNC
RUN mkdir ~/.vnc && \
    echo '#!/bin/bash\nstartxfce4 &' > ~/.vnc/xstartup && \
    chmod +x ~/.vnc/xstartup

# Descargar IntelliJ IDEA Community con JQ
RUN wget -qO idea_url.json "https://data.services.jetbrains.com/products/releases?code=IIC&latest=true&type=release" && \
    jq -r '.IIC[0].downloads.linux.link' idea_url.json > idea_url.txt && \
    wget -i idea_url.txt -O idea.tar.gz && \
    tar -xzf idea.tar.gz --strip-components=1 && \
    rm idea.tar.gz idea_url.json idea_url.txt

EXPOSE 5901

CMD ["vncserver", ":1", "-geometry", "1280x800", "-depth", "24"]
